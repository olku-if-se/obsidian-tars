# Needle DI Refactor Checklist (2025-10-20-144249)
**Updated: 2025-10-20 - Direct migration approach without feature flags**

## Migration Approach Clarifications
- **No feature flags** - Direct migration with immediate switch to DI system
- **Centralized tokens** - Move ALL tokens to `@tars/contracts` package
- **MCP refactoring** - Re-architect MCP implementation as part of DI migration to resolve circular dependencies
- **Testing strategy** - Migrate 1-2 representative unit tests per module, disable/archive other legacy tests
- **Providers** - Already DI-ready, just need reconnection to new container structure
- **Timeline** - No deadlines, work at developer's pace

## Preparation
- [ ] Read `docs/di-rules.md`, `docs/architecture/di/dependency-injection-refactoring-guide.md`, `docs/architecture/di/monorepo-di-patterns.md`, `docs/2025-10-20-140745-di-plan.v2.md`.
- [ ] Confirm tooling: `npx madge`, Node (>=18), Vitest, Biome, TypeScript 5.9.
- [ ] Run baseline dependency capture:
  - [ ] `cd packages/plugin && npx madge --extensions ts,tsx --json src > ../../docs/dependency-analysis/madge-YYYY-MM-DD.json`
  - [ ] Regenerate layered markdown via Node snippet (see dependency report doc).

## Phase 0: Token Centralization (Prerequisite)
- [ ] Update `packages/contracts/src/services/*.ts` to ensure interfaces exist for logging, notification, status, document, MCP, settings, command orchestration.
- [ ] Move ALL tokens from `packages/plugin/src/container/tokens.ts` to `packages/contracts/src/services/tokens.ts`
- [ ] Create missing tokens for any services not yet tokenized
- [ ] Update imports across all packages to use centralized tokens
- [ ] Move constants from:
  - [ ] `packages/plugin/src/commands/tagCmd.ts`
  - [ ] `packages/plugin/src/settings.ts`
  - [ ] `packages/plugin/src/statusBarManager.ts`
  into shared contract files (`packages/contracts/src/constants/*.ts`).

## Composition Root Rewrite
- [ ] Remove `packages/plugin/src/container/tokens.ts` (all tokens moved to contracts)
- [ ] Refactor `packages/plugin/src/container/plugin-container.ts`:
  - [ ] Import all tokens from `@tars/contracts`
  - [ ] Remove local token definitions
  - [ ] Use Needle DI bindings (`container.bind(TOKEN, { useClass: ... })`)
- [ ] Update `packages/plugin/src/main.ts`:
  - [ ] Replace old container usage with call to `buildPluginContainer()`
  - [ ] Remove any legacy instantiation patterns
- [ ] Update test harness:
  - [ ] `packages/plugin/src/container/__tests__/test-container.ts` - update to use centralized tokens
  - [ ] `packages/plugin/src/container/__tests__/plugin-container.test.ts` - update imports and bindings

## Phase 1 – Core Services (leaf modules)
- [ ] Verify core services already have `@injectable()` decorators:
  - [ ] `packages/plugin/src/services/ObsidianLoggingService.ts`
  - [ ] `packages/plugin/src/services/ObsidianNotificationService.ts`
  - [ ] `packages/plugin/src/services/ObsidianStatusService.ts`
  - [ ] `packages/plugin/src/services/ObsidianDocumentService.ts`
  - [ ] `packages/plugin/src/services/ObsidianSettingsService.ts`
  - Actions:
    - [ ] Update imports to use centralized tokens from `@tars/contracts`
    - [ ] Ensure constructors use `private dep = inject(Token)` pattern
    - [ ] Remove any remaining direct imports (logger, Notice, etc.) in favor of tokens
- [ ] Migrate representative tests (1-2 per service):
  - [ ] `packages/plugin/src/services/__tests__/ObsidianLoggingService.test.ts`
  - [ ] `packages/plugin/src/services/__tests__/ObsidianNotificationService.test.ts`
  - [ ] `packages/plugin/src/services/__tests__/ObsidianStatusService.test.ts`
  - [ ] `packages/plugin/src/services/__tests__/ObsidianDocumentService.test.ts`
  - Actions:
    - [ ] Update tests to use token-driven mocks
    - [ ] Create test container with centralized tokens
    - [ ] Archive/disable other legacy tests (move to `tests/legacy/` folder)

## Phase 2 – Command Handlers
- [ ] Activate DI command implementations:
  - [ ] `packages/plugin/src/commands/di/asstTagDI.ts`
  - [ ] `packages/plugin/src/commands/di/userTagDI.ts`
  - [ ] `packages/plugin/src/commands/di/systemTagDI.ts`
  Actions:
  - [ ] Update imports to use centralized tokens from `@tars/contracts`
  - [ ] Ensure constructor injection pattern
  - [ ] Remove any direct imports of services
- [ ] Replace legacy commands in main.ts:
  - [ ] Remove registration of legacy commands: `asstTag.ts`, `userTag.ts`, `systemTag.ts`
  - [ ] Enable registration of DI commands (currently commented out)
  - [ ] Update `packages/plugin/src/main.ts` to register DI commands via container
- [ ] Refactor remaining command files:
  - [ ] `packages/plugin/src/commands/newChatTag.ts` - convert to DI pattern
  - [ ] `packages/plugin/src/commands/tagCmd.ts` - move constants to contracts, inject services
  - [ ] `packages/plugin/src/commands/tagUtils.ts` - extract shared logic to service if needed
- [ ] Create command registration module:
  - [ ] `packages/plugin/src/commands/registerCommands.ts` - centralized command registration
- [ ] Migrate representative tests:
  - [ ] Create/update 1-2 command tests with DI container
  - [ ] Archive other command tests to `tests/legacy/`

## Phase 3 – React Bridge & Status
- [ ] Update React bridge components:
  - [ ] `packages/plugin/src/bridge/ReactBridge.ts` - inject required services
  - [ ] `packages/plugin/src/bridge/createReactContainer.ts` - use DI container for React context
  - [ ] `packages/plugin/src/reactSettingsTab.tsx` - inject services via React bridge
  Actions:
  - [ ] Create missing tokens for React bridge services in `@tars/contracts`
  - [ ] Update imports to use centralized tokens
- [ ] Refactor status management:
  - [ ] `packages/plugin/src/statusBarManager.ts` - convert to DI service
  - [ ] `packages/plugin/src/statusBarReact.ts` - ensure proper service injection
  Actions:
  - [ ] Analyze if `statusBarManager.ts` needs to be split (orchestration + store)
  - [ ] Ensure no direct imports of logging/settings
  - [ ] Create status token if not exists
- [ ] Create registration modules:
  - [ ] `packages/plugin/src/status/registerStatusBar.ts` - status service registration
  - [ ] `packages/plugin/src/bridge/registerBridge.ts` - React bridge registration
- [ ] Migrate representative tests:
  - [ ] Create/update 1 test for React bridge with DI
  - [ ] Create/update 1 test for status manager with DI
  - [ ] Archive other React/Status tests to `tests/legacy/`

## Phase 4 – MCP Services (Re-architecture)
**Goal: Resolve circular dependencies through proper DI structure**

- [ ] Analyze and redesign MCP service structure:
  - [ ] Map current circular dependencies in MCP services
  - [ ] Design new service boundaries to eliminate cycles
  - [ ] Create new service interfaces if needed (e.g., separate executor from manager)
- [ ] Refactor MCP services with DI:
  - [ ] `packages/plugin/src/services/ObsidianMcpService.ts` - complete DI integration
  - [ ] `packages/plugin/src/mcp/toolCallingCoordinator.ts` - inject dependencies, remove cycles
  - [ ] `packages/plugin/src/mcp/codeBlockProcessor.ts` - convert to DI service
  - [ ] `packages/plugin/src/mcp/executor.ts` - split if needed to resolve dependencies
  - [ ] `packages/plugin/src/mcp/managerMCPUse.ts` - restructure as DI service
  Actions:
  - [ ] Add missing tokens to `@tars/contracts` for all MCP services
  - [ ] Apply constructor injection pattern
  - [ ] Remove direct instantiation and imports
- [ ] Update MCP integration points:
  - [ ] `packages/plugin/src/mcp/providerAdapters.ts` - use injected MCP services
  - [ ] `packages/plugin/src/mcp/adapters/StatusBarReporter.ts` - inject status service
  - [ ] `packages/plugin/src/mcp/documentSessionHandlers.ts` - inject document service
  - [ ] `packages/plugin/src/mcp/providerIntegration.ts` - update to use DI
- [ ] Update MCP UI:
  - [ ] `packages/plugin/src/modals/toolBrowserModal.ts` - inject services via container
- [ ] Enable MCP in container:
  - [ ] Uncomment MCP services in `plugin-container.ts` after fixing token issues
  - [ ] Create `packages/plugin/src/mcp/registerMcp.ts` - MCP service registration module
- [ ] Migrate representative tests:
  - [ ] Create/update 1-2 MCP service tests with DI container
  - [ ] Archive other MCP tests to `tests/legacy/`

## Phase 5 – Settings & UI Cycle Break
- [ ] Complete settings service DI integration:
  - [ ] `packages/plugin/src/services/ObsidianSettingsService.ts` - verify DI pattern
- [ ] Break circular dependencies in settings:
  - [ ] `packages/plugin/src/settings.ts` - extract interface to contracts, remove direct usage
  - [ ] `packages/plugin/src/settingTab.ts` - split into controller + view components
  - [ ] `packages/plugin/src/reactSettingsTab.tsx` - ensure it uses injected services
  - [ ] `packages/plugin/src/adapters/reactSettingsAdapter.ts` - update for DI
  Actions:
  - [ ] Create `ISettingsPersistence` interface in contracts
  - [ ] Inject settings service where needed instead of direct imports
  - [ ] Create `SettingsViewController` with DI
- [ ] Update dependent components:
  - [ ] `packages/plugin/src/featureFlags.ts` - convert to service with DI
  - [ ] `packages/plugin/src/editor.ts` - inject settings service, remove direct import
  - [ ] `packages/plugin/src/suggest.ts` - inject required services
  Actions:
  - [ ] Remove direct settings imports
  - [ ] Use injected settings service
  - [ ] Create feature flags token and service
- [ ] Migrate representative tests:
  - [ ] Create/update 1 test for settings service with DI
  - [ ] Create/update 1 test for editor with injected settings
  - [ ] Archive other settings/UI tests to `tests/legacy/`

## Phase 6 – Provider Reconnection
- [ ] Verify provider DI readiness:
  - [ ] Check `ClaudeDIProvider`, `OpenAIProvider`, `OllamaDIProvider` for proper DI integration
  - [ ] Ensure all providers use centralized tokens from `@tars/contracts`
- [ ] Update provider factory:
  - [ ] Modify provider instantiation to use DI container
  - [ ] Remove manual provider instantiation
- [ ] Remove legacy providers:
  - [ ] Archive non-DI provider versions (move to `src/providers/legacy/`)
  - [ ] Update provider registration to use DI versions only
- [ ] Migrate representative tests:
  - [ ] Create/update 1 provider test with DI container
  - [ ] Archive other provider tests to `tests/legacy/`

## Validation After Each Phase
- [ ] `pnpm lint` (run from monorepo root)
- [ ] `pnpm test` (expect some legacy tests to be skipped/archived)
- [ ] `pnpm build`
- [ ] Manual smoke: load plugin in dev vault
- [ ] Re-run `madge` snapshot:
  ```bash
  cd packages/plugin && npx madge --extensions ts,tsx --json src > ../../docs/dependency-analysis/madge-YYYY-MM-DD.json
  ```
- [ ] Generate layered markdown and compare with baseline

## Cycle Resolution Tasks
- [ ] Verify no remaining cycles in dependency report
- [ ] If cycles persist:
  - [ ] Extract shared contracts from offending files
  - [ ] Focus on: `main.ts`, `settings.ts`, `reactSettingsTab.tsx`, `statusBarReact.ts`
  - [ ] Create interfaces in contracts for shared functionality
- [ ] Repeat refactor loop until cycle-free

## Cleanup Tasks
- [ ] Remove all legacy code:
  - [ ] Delete archived folders after verification
  - [ ] Remove commented-out legacy code
  - [ ] Clean up unused imports
- [ ] Update documentation:
  - [ ] Update `CLAUDE.md` with DI patterns
  - [ ] Create DI migration ADR document
  - [ ] Update API documentation

## Final Verification
- [ ] Full test suite passes (only DI tests remain)
- [ ] Build completes without errors
- [ ] Plugin loads and functions correctly in Obsidian
- [ ] Final dependency report shows clean, acyclic structure
- [ ] Archive this checklist to `docs/di-migration-complete/`
