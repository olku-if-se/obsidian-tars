# See: https://mise.jdx.dev/tasks/


[tools]
node = "24"
age = "latest"   # Encryption tool for SOPS
sops = "latest"  # Secret encryption/decryption

# ============================================================================
# Settings - SOPS for Encrypted Secrets
# ============================================================================

[settings]
experimental = true
verbose = false                             # enable if SOPS is failing or you need more debug details
sops.age_key_file = "{{config_root}}/.secrets/mise-age.txt"  # Absolute path from config root
sops.rops = false                           # use original SOPS binary not a rops library
sops.strict = false                         # if age key is not provided do not raise an ERROR

[[env]]
# SOPS age key configuration (absolute path from config root)
MISE_SOPS_AGE_KEY_FILE = "{{config_root}}/.secrets/mise-age.txt"
SOPS_AGE_KEY_FILE = "{{env.MISE_SOPS_AGE_KEY_FILE}}"

[[env]]
# Load encrypted secrets (from root directory where mise.toml is located)
_.file = ["{{config_root}}/.env.secrets.json"]

[tasks.secrets-edit]
description = "‚úèÔ∏è  Edit encrypted secrets"
run = "sops .env.secrets.json"

[tasks.secrets-show]
description = "üëÅÔ∏è  Show decrypted secrets (be careful!)"
run = "sops --decrypt .env.secrets.json"

[tasks.secrets-rotate]
description = "üîÑ Rotate a single API key (usage: mise run secrets-rotate KEY_NAME new-value)"
run = "bash bin/secrets-rotate.sh"

[tasks.claude]
description = "ü§ñ Launch Claude CLI with default Anthropic configuration"
run = """
#!/bin/bash
set -e

echo "üöÄ Launching Claude CLI with default Anthropic configuration..."

# Ensure no z.ai environment variables are set (use defaults from ~/.claude/settings.json)
unset ANTHROPIC_AUTH_TOKEN
unset ANTHROPIC_BASE_URL
unset API_TIMEOUT_MS
unset ANTHROPIC_DEFAULT_HAIKU_MODEL
unset ANTHROPIC_DEFAULT_SONNET_MODEL
unset ANTHROPIC_DEFAULT_OPUS_MODEL

echo "‚úÖ Using default Claude configuration from ~/.claude/settings.json"
echo "üîó Base URL: Default (api.anthropic.com)"
echo "ü§ñ Models: Default Anthropic models (claude-3-haiku, claude-3-5-sonnet, claude-3-opus)"
echo "‚ö†Ô∏è  Make sure to set ANTHROPIC_API_KEY in your environment or ~/.claude/settings.json"
echo ""

# Launch Claude CLI with default configuration
exec claude
"""

[tasks.claude-zai]
description = "ü§ñ Launch Claude CLI with z.ai configuration"
run = """
#!/bin/bash
set -e

echo "üöÄ Launching Claude CLI with z.ai configuration..."

# Check if ZAI_AUTH_TOKEN is set
if [[ -z "$ZAI_AUTH_TOKEN" ]]; then
  echo "‚ùå ZAI_AUTH_TOKEN environment variable is not set!"
  echo ""
  echo "üí° To fix this:"
  echo "   1. Add ZAI_AUTH_TOKEN to your .env file"
  echo "   2. Or export it manually: export ZAI_AUTH_TOKEN=\"your-token-here\""
  echo "   3. Or add it to .env.secrets.json using: mise run secrets-edit"
  echo ""
  exit 1
fi

# Set environment variables for z.ai (these override ~/.claude/settings.json)
export ANTHROPIC_AUTH_TOKEN="$ZAI_AUTH_TOKEN"
export ANTHROPIC_BASE_URL="https://api.z.ai/api/anthropic"
export API_TIMEOUT_MS="3000000"
export ANTHROPIC_DEFAULT_HAIKU_MODEL="glm-4.5-air"
export ANTHROPIC_DEFAULT_SONNET_MODEL="glm-4.6"
export ANTHROPIC_DEFAULT_OPUS_MODEL="glm-4.6"

echo "‚úÖ Environment configured for z.ai"
echo "üîó Base URL: $ANTHROPIC_BASE_URL"
echo "ü§ñ Models: Haiku=$ANTHROPIC_DEFAULT_HAIKU_MODEL, Sonnet=$ANTHROPIC_DEFAULT_SONNET_MODEL, Opus=$ANTHROPIC_DEFAULT_OPUS_MODEL"
echo "üîë Token: ${ANTHROPIC_AUTH_TOKEN:0:20}..."
echo ""

# Launch Claude CLI with the configured environment
exec claude
"""
